FROM node:22-alpine AS base
ENV PNPM_HOME="/pnpm"
ENV PATH="$PNPM_HOME:$PATH"
RUN corepack enable

ARG SERVER_PORT
ARG ENV
ARG DO_DB_NAME
ARG DO_DB_PORT
ARG DO_DB_HOST
ARG DO_DB_USERNAME
ARG DO_DB_PASSWORD
ARG SALT
ARG AT_SECRET
ARG RT_SECRET
ARG MAIL_HOST
ARG MAIL_PORT
ARG MAIL_USER
ARG MAIL_PASSWORD
ARG MAIL_FROM
ARG REDIS_HOST
ARG REDIS_PORT
ARG REDIS_USER
ARG REDIS_PASSWORD
ARG OPENAI_API_KEY
ARG OPENAI_ENDPOINT
ARG OPENAI_MODEL
ARG ELS_IP
ARG ELS_USERNAME
ARG ELS_PASSWORD

ENV SERVER_PORT=${SERVER_PORT}
ENV ENV=${ENV}
ENV DO_DB_NAME=${DO_DB_NAME}
ENV DO_DB_PORT=${DO_DB_PORT}
ENV DO_DB_HOST=${DO_DB_HOST}
ENV DO_DB_USERNAME=${DO_DB_USERNAME}
ENV DO_DB_PASSWORD=${DO_DB_PASSWORD}
ENV SALT=${SALT}
ENV AT_SECRET=${AT_SECRET}
ENV RT_SECRET=${RT_SECRET}
ENV MAIL_HOST=${MAIL_HOST}
ENV MAIL_PORT=${MAIL_PORT}
ENV MAIL_USER=${MAIL_USER}
ENV MAIL_PASSWORD=${MAIL_PASSWORD}
ENV MAIL_FROM=${MAIL_FROM}
ENV REDIS_HOST=${REDIS_HOST}
ENV REDIS_PORT=${REDIS_PORT}
ENV REDIS_USER=${REDIS_USER}
ENV REDIS_PASSWORD=${REDIS_PASSWORD}
ENV OPENAI_API_KEY=${OPENAI_API_KEY}
ENV OPENAI_ENDPOINT=${OPENAI_ENDPOINT}
ENV OPENAI_MODEL=${OPENAI_MODEL}
ENV ELS_IP=${ELS_IP}
ENV ELS_USERNAME=${ELS_USERNAME}
ENV ELS_PASSWORD=${ELS_PASSWORD}

WORKDIR /server

RUN echo "node_modules\n.env\n*.log" > .dockerignore

COPY package*.json pnpm-lock.yaml ./

RUN pnpm config set registry https://registry.npmjs.org
RUN pnpm config set fetch-retries 5
RUN pnpm config set fetch-retry-mintimeout 20000
RUN pnpm config set fetch-retry-maxtimeout 60000
RUN pnpm config set network-concurrency 1
RUN pnpm config set public-hoist-pattern="*"

RUN pnpm install --no-frozen-lockfile

COPY . .

RUN pnpm run build

EXPOSE ${SERVER_PORT}

CMD ["pnpm", "run", "start:prod"]